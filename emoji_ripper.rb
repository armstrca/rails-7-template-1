require "httparty"
require "fileutils"
require "digest"
require "set"
require "concurrent"

# Define the list of emoji code points you want to combine
emoji_list = [
  "â¤ï¸", "ğŸ§¡", "ğŸ’›", "ğŸ’š", "ğŸ©µ", "ğŸ’™", "ğŸ’œ", "ğŸ©·", "ğŸ¤", "ğŸ©¶", "ğŸ–¤", "ğŸ¤",
  "ğŸª„", "ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ¤£", "ğŸ˜‚", "ğŸ™‚", "ğŸ™ƒ", "ğŸ« ",
  "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‡", "ğŸ¥°", "ğŸ˜", "ğŸ¤©", "ğŸ˜˜", "ğŸ˜—", "â˜ºï¸", "ğŸ˜š", "ğŸ˜™", "ğŸ¥²",
  "ğŸ˜‹", "ğŸ˜›", "ğŸ˜œ", "ğŸ¤ª", "ğŸ˜", "ğŸ¤‘", "ğŸ¤—", "ğŸ¤­", "ğŸ«¢", "ğŸ«£", "ğŸ¤«", "ğŸ¤”",
  "ğŸ«¡", "ğŸ¤", "ğŸ¤¨", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¶", "ğŸ«¥", "ğŸ˜¶â€ğŸŒ«ï¸", "ğŸ˜", "ğŸ˜’", "ğŸ™„",
  "ğŸ˜¬", "ğŸ˜®â€ğŸ’¨", "ğŸ¤¥", "ğŸ˜Œ", "ğŸ˜”", "ğŸ˜ª", "ğŸ¤¤", "ğŸ˜´", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•",
  "ğŸ¤¢", "ğŸ¤®", "ğŸ¤§", "ğŸ¥µ", "ğŸ¥¶", "ğŸ¥´", "ğŸ˜µ", "ğŸ¤¯", "ğŸ¤ ", "ğŸ¥³", "ğŸ¥¸", "ğŸ˜",
  "ğŸ¤“", "ğŸ§", "ğŸ˜•", "ğŸ«¤", "ğŸ˜Ÿ", "ğŸ™", "â˜¹ï¸", "ğŸ˜®", "ğŸ˜¯", "ğŸ˜²", "ğŸ˜³",
  "ğŸ¥º", "ğŸ¥¹", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜±", "ğŸ˜–",
  "ğŸ˜£", "ğŸ˜", "ğŸ˜“", "ğŸ˜©", "ğŸ˜«", "ğŸ¥±", "ğŸ˜¤", "ğŸ˜¡", "ğŸ˜ ", "ğŸ¤¬", "ğŸ˜ˆ",
  "ğŸ‘¿", "ğŸ’€", "ğŸ’©", "ğŸ¤¡", "ğŸ‘¹", "ğŸ‘º", "ğŸ‘»", "ğŸ‘½", "ğŸ¤–", "ğŸ™ˆ", "ğŸ’Œ",
  "ğŸ’˜", "ğŸ’", "ğŸ’–", "ğŸ’—", "ğŸ’“", "ğŸ’", "ğŸ’•", "â£ï¸", "ğŸ’”", "â¤ï¸â€ğŸ©¹", "ğŸ’‹",
  "ğŸ’¯", "ğŸ’¥", "ğŸ’«", "ğŸ•³ï¸", "ğŸ’¬", "ğŸ—¯ï¸", "ğŸ‘", "ğŸ§ ", "ğŸ«€", "ğŸ«", "ğŸ¦·",
  "ğŸ¦´", "ğŸ‘€", "ğŸ‘ï¸", "ğŸ‘„", "ğŸ«¦", "ğŸ¤·", "ğŸ—£ï¸", "ğŸ‘¤", "ğŸ‘¥", "ğŸ«‚", "ğŸ‘£",
  "ğŸµ", "ğŸ¶", "ğŸ©", "ğŸº", "ğŸ¦Š", "ğŸ¦", "ğŸ±", "ğŸ¦", "ğŸ¯", "ğŸ¦„", "ğŸ¦Œ",
  "ğŸ®", "ğŸ·", "ğŸ", "ğŸ¦™", "ğŸ­", "ğŸ°", "ğŸ¦”", "ğŸ¦‡", "ğŸ»", "ğŸ¨", "ğŸ¼",
  "ğŸ¦¥", "ğŸ¾", "ğŸ”", "ğŸ¦", "ğŸ§", "ğŸ•Šï¸", "ğŸ¦‰", "ğŸ¦©", "ğŸª¿", "ğŸ¸", "ğŸ¢",
  "ğŸ‰", "ğŸ³", "ğŸŸ", "ğŸ¦ˆ", "ğŸ™", "ğŸš", "ğŸª¸", "ğŸŒ", "ğŸ¦‹", "ğŸ", "ğŸª²",
  "ğŸ", "ğŸ¦—", "ğŸª³", "ğŸ•·ï¸", "ğŸ¦‚", "ğŸ¦ ", "ğŸ’", "ğŸŒ¸", "ğŸ’®", "ğŸª·", "ğŸµï¸",
  "ğŸŒ¹", "ğŸ¥€", "ğŸŒº", "ğŸŒ»", "ğŸŒ¼", "ğŸŒ·", "ğŸª»", "ğŸŒ±", "ğŸª´", "ğŸŒ²", "ğŸŒ³",
  "ğŸŒ´", "ğŸŒµ", "ğŸŒ¾", "ğŸŒ¿", "ğŸ€", "ğŸ", "ğŸ‚", "ğŸƒ", "ğŸª¹", "ğŸ„", "ğŸ‡",
  "ğŸˆ", "ğŸ‰", "ğŸŠ", "ğŸ‹", "ğŸŒ", "ğŸ", "ğŸ¥­", "ğŸ", "ğŸ", "ğŸ’", "ğŸ“",
  "ğŸ«", "ğŸ¥", "ğŸ…", "ğŸ«’", "ğŸ¥¥", "ğŸ¥‘", "ğŸ¥”", "ğŸ¥•", "ğŸŒ½", "ğŸŒ¶ï¸", "ğŸ«‘",
  "ğŸ¥’", "ğŸ¥¬", "ğŸ¥¦", "ğŸ§„", "ğŸ§…", "ğŸ¥œ", "ğŸ«˜", "ğŸŒ°", "ğŸ«š", "ğŸ«›", "ğŸ",
  "ğŸ¥", "ğŸ«“", "ğŸ¥¨", "ğŸ¥¯", "ğŸ¥", "ğŸ§‡", "ğŸ§€", "ğŸ–", "ğŸ—", "ğŸ¥©", "ğŸ¥“",
  "ğŸ”", "ğŸŸ", "ğŸŒ­", "ğŸ¥ª", "ğŸŒ®", "ğŸŒ¯", "ğŸ«”", "ğŸ¥™", "ğŸ§†", "ğŸ³", "ğŸ¥˜",
  "ğŸ²", "ğŸ«•", "ğŸ¥£", "ğŸ¥—", "ğŸ¿", "ğŸ§ˆ", "ğŸ§‚", "ğŸ¥«", "ğŸ±", "ğŸ˜", "ğŸ™",
  "ğŸš", "ğŸ›", "ğŸœ", "ğŸ", "ğŸ ", "ğŸ¢", "ğŸ£", "ğŸ¤", "ğŸ¥", "ğŸ¡", "ğŸ¥Ÿ",
  "ğŸ¥ ", "ğŸ¥¡", "ğŸ¦€", "ğŸ¦", "ğŸ¦ª", "ğŸ¦", "ğŸ§", "ğŸ¨", "ğŸ©", "ğŸª", "ğŸ‚",
  "ğŸ°", "ğŸ§", "ğŸ¥§", "ğŸ«", "ğŸ¬", "ğŸ­", "ğŸ®", "ğŸ¯", "ğŸ¼", "ğŸ¥›", "â˜•",
  "ğŸ«–", "ğŸµ", "ğŸ¶", "ğŸ¾", "ğŸ·", "ğŸ¹", "ğŸ¥‚", "ğŸ«—", "ğŸ¥¤", "ğŸ§‹", "ğŸ§ƒ",
  "ğŸ§‰", "ğŸ§Š", "ğŸ¥¢", "ğŸ½ï¸", "ğŸº", "ğŸŒ", "ğŸ”ï¸", "â›°ï¸", "ğŸŒ‹", "ğŸ•ï¸",
  "ğŸ–ï¸", "ğŸï¸", "ğŸï¸", "ğŸŸï¸", "ğŸ›ï¸", "ğŸ§±", "ğŸª¨", "ğŸªµ", "ğŸšï¸", "ğŸ ",
  "ğŸ°", "ğŸ—¼", "ğŸŒ„", "ğŸŒ‡", "â™¨ï¸", "ğŸ ", "ğŸ¡", "ğŸ¢", "ğŸª", "ğŸš‚", "ğŸš‡",
  "ğŸšŒ", "ğŸš•", "ğŸš—", "ğŸšš", "ğŸš›", "ğŸšœ", "ğŸï¸", "ğŸï¸", "ğŸš²", "ğŸ›´",
  "ğŸ›¹", "ğŸ›¼", "ğŸ›£ï¸", "â›½", "ğŸš¨", "ğŸš¦", "ğŸ›‘", "ğŸš§", "âš“", "ğŸ›Ÿ",
  "ğŸ›¶", "âœˆï¸", "ğŸª‚", "ğŸš ", "ğŸš¡", "ğŸš€", "ğŸ›¸", "ğŸ§³", "âŒ›", "â³", "âŒš",
  "â°", "ğŸ•°ï¸", "ğŸŒš", "ğŸŒ›", "ğŸŒœ", "ğŸŒ¡ï¸", "ğŸŒ", "ğŸŒ", "ğŸª", "â­",
  "ğŸŒŸ", "ğŸŒŒ", "â˜ï¸", "â›…", "ğŸŒ§ï¸", "ğŸŒ©ï¸", "ğŸŒªï¸", "ğŸŒ¬ï¸", "ğŸŒ€", "ğŸŒˆ",
  "â˜‚ï¸", "âš¡", "â›„", "â˜„ï¸", "ğŸ”¥", "ğŸ’§", "ğŸŒŠ", "ğŸƒ", "ğŸ†", "ğŸˆ",
  "ğŸŠ", "ğŸ€", "ğŸ", "ğŸ—ï¸", "ğŸŸï¸", "ğŸ–ï¸", "ğŸ†", "ğŸ…", "ğŸ¥‡", "ğŸ¥ˆ",
  "ğŸ¥‰", "âš½", "âš¾", "ğŸ¥", "ğŸ€", "ğŸ", "ğŸˆ", "ğŸ‰", "ğŸ¾", "ğŸ¥",
  "ğŸ³", "ğŸ", "ğŸ‘", "ğŸ’", "ğŸ¥", "ğŸ“", "ğŸ¸", "ğŸ¥Š", "ğŸ¥‹", "ğŸ¥…",
  "â›³", "â›¸ï¸", "ğŸ£", "ğŸ¤¿", "ğŸ½", "ğŸ¿", "ğŸ›·", "ğŸ¥Œ", "ğŸ¯", "ğŸª€",
  "ğŸª", "ğŸ±", "ğŸ”®", "ğŸ®", "ğŸ°", "ğŸ²", "ğŸ§©", "ğŸª©", "â™ ï¸", "â™¥ï¸",
  "â™Ÿï¸", "ğŸƒ", "ğŸ€„", "ğŸ´", "ğŸ­", "ğŸ–¼ï¸", "ğŸ¨", "ğŸ§µ", "ğŸª¡", "ğŸ§¶",
  "ğŸ‘•", "ğŸ§¦", "ğŸ‘—", "ğŸª­", "ğŸ‘œ", "ğŸ›ï¸", "ğŸ‘Ÿ", "ğŸ¥¿", "ğŸ‘ ", "ğŸ©°",
  "ğŸª®", "ğŸ‘‘", "ğŸ‘’", "ğŸ“", "ğŸ’", "ğŸ’", "ğŸ”ˆ", "ğŸ“£", "ğŸ””", "ğŸ¶",
  "ğŸ™ï¸", "ğŸšï¸", "ğŸ›ï¸", "ğŸ¤", "ğŸ§", "ğŸ“»", "ğŸ·", "ğŸª—", "ğŸ¸", "ğŸ¹",
  "ğŸº", "ğŸ»", "ğŸª•", "ğŸ¥", "ğŸª˜", "ğŸª‡", "ğŸªˆ", "ğŸ“±", "â˜ï¸", "ğŸ“Ÿ",
  "ğŸ“ ", "ğŸ”‹", "ğŸª«", "ğŸ”Œ", "ğŸ’»", "ğŸ–¨ï¸", "ğŸ’¾", "ğŸ’¿", "ğŸï¸", "ğŸ¬",
  "ğŸ“º", "ğŸ“·", "ğŸ“¼", "ğŸ”", "ğŸ’¡", "ğŸª”", "ğŸ“š", "ğŸ“°", "ğŸ’¸", "ğŸ“¦",
  "ğŸ—³ï¸", "âœï¸", "âœ’ï¸", "ğŸ–Šï¸", "ğŸ–Œï¸", "ğŸ–ï¸", "ğŸ“ˆ", "ğŸ“‰", "ğŸ“Š",
  "ğŸ–‡ï¸", "ğŸ“", "âœ‚ï¸", "ğŸ—ƒï¸", "ğŸ—‘ï¸", "ğŸ”’", "ğŸ—ï¸", "â›ï¸", "ğŸ› ï¸",
  "ğŸªƒ", "ğŸ¹", "âš™ï¸", "âš–ï¸", "â›“ï¸", "ğŸ§²", "ğŸ§ª", "ğŸ§¬", "ğŸ”¬",
  "ğŸ”­", "ğŸ©¸", "ğŸ©º", "ğŸ›‹ï¸", "ğŸª¤", "ğŸª’", "ğŸ§¹", "ğŸ§º", "ğŸ§¼", "ğŸ«§",
  "ğŸ›’", "ğŸ§¿", "ğŸ—¿", "ğŸš®", "âš ï¸", "â˜¢ï¸", "â˜£ï¸", "â˜¯ï¸", "â˜®ï¸",
  "â™ˆ", "â™‰", "â™Š", "â™‹", "â™Œ", "â™", "â™", "â™", "â™", "â™‘",
  "â™’", "â™“", "â›", "ğŸ“´", "âœ–ï¸", "â•", "â–", "â—", "â™¾ï¸", "â‰ï¸",
  "â“", "â—", "ã€°ï¸", "â™»ï¸", "âœ…", "â°", "â¿", "Â©ï¸", "Â®ï¸", "â„¢ï¸",
  "ğŸ”¢", "ğŸ†’", "ğŸ†“", "ğŸ†•", "ğŸ†—", "ğŸ†˜", "ğŸ†™", "ğŸ", "ğŸ", "ğŸ‘¾"
]
download_folder = "./emoji_pngs"
downloaded_images = {}
not_found_combinations = Set.new

# Thread pool for concurrent HTTP requests
thread_pool = Concurrent::FixedThreadPool.new(10)

def download_emoji_image(emoji1, emoji2, size, download_folder, downloaded_images, not_found_combinations, not_found_image_hash)
  # Skip if this combination or its reverse has been processed
  return if not_found_combinations.include?([emoji1, emoji2]) || not_found_combinations.include?([emoji2, emoji1])

  encoded_emoji1 = URI.encode_www_form_component(emoji1)
  encoded_emoji2 = URI.encode_www_form_component(emoji2)
  url = "https://emojik.vercel.app/s/#{encoded_emoji1}_#{encoded_emoji2}?size=#{size}"
  response = HTTParty.get(url)

  if response.code == 200
    file_name = "#{emoji1}_#{emoji2}.png"
    file_path = "#{download_folder}/#{file_name}"

    image_hash = Digest::SHA256.hexdigest(response.body)

    if image_hash == not_found_image_hash
      not_found_combinations << [emoji1, emoji2]
      not_found_combinations << [emoji2, emoji1]
      puts "Invalid emoji combo: #{file_name}, status: #{response.code}"
    elsif downloaded_images[image_hash].nil?
      File.open(file_path, "wb") { |file| file.write(response.body) }
      downloaded_images[image_hash] = file_name
      puts "Downloaded: #{file_name}, code: #{response.code}"
    else
      puts "Already downloaded: #{file_name}, code: #{response.code}"
    end
  else
    puts "Failed to download: #{emoji1}_#{emoji2}"
    not_found_combinations << [emoji1, emoji2]
    not_found_combinations << [emoji2, emoji1]
  end
end

# Load or compute the 'not found' image hash
def load_not_found_image_hash(sample_image_path)
  File.open(sample_image_path, "rb") { |file| Digest::SHA256.hexdigest(file.read) }
end

not_found_image_hash = load_not_found_image_hash("/home/calvin/rails-7-template/downloaded_pngs/â¤ï¸_ğŸ˜„.png")

# Prepare the directory
FileUtils.mkdir_p(download_folder) unless Dir.exist?(download_folder)

# Process emoji pairs concurrently
emoji_list.combination(2).each do |emoji1, emoji2|
  thread_pool.post do
    download_emoji_image(emoji1, emoji2, 128, download_folder, downloaded_images, not_found_combinations, not_found_image_hash)
  end
end

# Shutdown thread pool and wait for all tasks to complete
thread_pool.shutdown
thread_pool.wait_for_termination